---
title: "Weather Radials"
author: "Jaeyoon Han"
date: '2016-03-26'
output: html_document
layout: post
image: /assets/article_images/2016-03-26-weather-radial/weather1.jpg
categories: Visualizing
---


## Creating weather radials with highcharter and ggplot2.

---

본 내용은 `highcharter` 패키지의 제작자인 [Joshua Kunst](http://jkunst.com)의 블로그의 포스트를 더 자세하게 재작성한 것임을 밝힌다.

본 작업에서는 다음의 다섯 가지의 패키지를 사용한다. 그 중 `highcharter`는 최근 등록된 패키지로 깃허브에서 계속해서 베타 버전이 개발되고 있어 깃허브 저장소를 통해 설치할 수도 있다. 이 경우 `devtool` 라이브러리를 불러와서 개발자 모드로 설치하면 된다. 이 경우 2016년 3월 26일 기준으로 0.2.0.9999 버전이 설치된다. 불편한 부분이 다소 있는데, 로컬 라이브러리에 설치되지 않기 때문에, R 세션을 실행할 때마다 설치해줘야 한다. 또한 설치가 된 상태더라도 `knitr`를 통해서 마크다운을 작성할 때 라이브러리 인식이 되지 않는다. 본인은 제작자의 깃허브에서 패키지를 받아 tar.gz 로 압축하여 로컬 라이브러리에 직접 설치해서 문제를 해결했다. 
기존 저장소를 통해 받으려면 단순히 `install.packages("highcharter")`를 통해 설치하면 된지만, 본 예제에 있는 몇몇 함수들이 작동하지 않는다. 알아두길 바란다.

```{r eval=FALSE}
library(devtools)
devtools::install_github("jbkunst/highcharter")
```

```{r, message=FALSE, warning=FALSE}
library(highcharter)
library(ggplot2)
library(dplyr)
library(stringr)
library(lubridate)
```

데이터를 불러온다.

```{r}
weather <- tbl_df(read.csv("http://bl.ocks.org/bricedev/raw/458a01917183d98dff3c/sf.csv"))

weather
```

칼럼 이름을 소문자로 바꾸고, 공백은 언더바로 치환한다.

```{r}
names(weather) <- names(weather) %>%
        str_to_lower() %>%
        str_replace("\\s+", "_")
```

기존 데이터에 `mutate()` 함수를 이용해서 `id`와 날짜 형식으로 데이터 포맷을 바꾼 `date2`, 타임스탬프, 월 데이터를 추가한다.

```{r}
weather <- weather %>%
        mutate(id = seq(nrow(weather)),
               date2 = as.Date(ymd(date)),
               tmstmp = datetime_to_timestamp(date2),
               month = month(ymd(date)))
```

`dsmax`에는 타임스탬프와 최대 섭씨온도를 각각 x, y 좌표로 입력해준 데이터를 저장한다.

```{r}
dsmax <- weather %>%
        select(x = tmstmp,
               y = max.temperaturec) %>%
        list.parse3()
```

`dsmin`에는 타임스탬프와 최저 섭씨온도를 입력한 데이터를 저장한다.
```{r}
dsmin <- weather %>%
        select(x = tmstmp,
               y = min.temperaturec) %>%
        list.parse3()
```

`highchart()` 함수를 이용해 차트를 생성한다.

```{r eval=FALSE}
hc <- highchart() %>%
        hc_chart(type = "line") %>%
        hc_xAxis(type = "datetime",
                tickInterval = 30 * 24 * 3600 * 1000,
                labels = list(format = "{value: %b}")) %>%
        hc_yAxis(min = 0,
                labels = list(format = "{value} C")) %>%
        hc_add_series(data = dsmax, name = "max") %>%
        hc_add_series(data = dsmin, name = "min") %>%
        hc_add_theme(hc_theme_smpl())
hc

hc <- hc %>%
        hc_chart(type = "column") %>%
        hc_plotOptions(series = list(stacking = "normal"))

hc
```

마지막으로 원형 그래프를 그려주기 위한 데이터를 생성한다.

```{r}
dsmax <- weather %>%
        mutate(color = colorize_vector(mean.temperaturec, "A"),
               y = max.temperaturec - min.temperaturec) %>%
        select(x = tmstmp,
               y,
               name = date,
               color,
               mean = mean.temperaturec,
               max = max.temperaturec,
               min = min.temperaturec) %>%
        list.parse3()
```

툴팁을 만들어주기 위해 다음의 코드를 실행한다.

```{r}
x <- c("Min", "Mean", "Max")
y <- sprintf("{point.%s}", tolower(x))
tltip <- tooltip_table(x, y)
```

```{r eval=FALSE}
hc <- highchart() %>%
        hc_chart(type = "column",
                 polar = TRUE) %>%
        hc_plotOptions(series = list(stacking = "normal",
                                     showInLegend = FALSE)) %>%
        hc_xAxis(gridLineWidth = 0.5,
                 type = "datetime",
                 tickInterval = 30 * 24 * 3600 * 1000,
                 labels = list(format = "{value: %b}")) %>%
        hc_yAxis(max = 30,
                 min = -10,
                 labels = list(format = "{value} C"),
                 showFirstLabel = FALSE) %>%
        hc_add_series(data = dsmax) %>%
        hc_add_series(data = dsmin,
                      color = "transparent",
                      enableMouseTracking = FALSE) %>%
        hc_add_theme(hc_theme_smpl()) %>%
        hc_tooltip(useHTML = TRUE,
                   headerFormat = as.character(tags$small("{point.x:%d %B, %Y}")),
                   pointFormat = tltip)

hc
```

덧 : 결과물이 굉장히 만족스럽다. Highchart를 다루기 위해서는 내부 파라미터나 옵션들을 보다 상세하게 공부해야 할 듯 하다. 단순히 기존 예제를 답습하기 보다는, 새로운 데이터로 다른 시도를 해봐야겠다.

`ggplot2`를 사용해 비슷한 그래프를 얻어내는 것은 생각보다 간단했다.

```{r, fig.height=6, fig.width=10}
library(ggplot2)
library(viridis)
library(scales)

ggplot(weather, aes(date2, ymin = min.temperaturec,
                    ymax = max.temperaturec, color = mean.temperaturec)) +
        geom_linerange(size = 1.3, alpha = 0.75) + 
        scale_color_viridis(NULL, option = "A") + 
        scale_x_date(labels = date_format("%b"),
                     breaks = date_breaks("month")) + 
        ylim(-10, 35) + 
        labs(title = "San Francisco Weather Radial",
             x = NULL, y = NULL) +
        coord_polar() + 
        theme_minimal(base_family = "Lato Semibold") + 
        theme(legend.position = "bottom")
```

